<html xmlns:o="urn:schemas-microsoft-com:office:office"xmlns:w="urn:schemas-microsoft-com:office:word"xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=Title content="Wrapper infrastructure"><meta name=Keywords content=""><meta http-equiv=Content-Type content="text/html; charset=macintosh"><meta name=ProgId content=Word.Document><meta name=Generator content="Microsoft Word 10"><meta name=Originator content="Microsoft Word 10"><link rel=File-List href="wrappers_files/filelist.xml"><title>Wrapper infrastructure</title><!--[if gte mso 9]><xml> <o:DocumentProperties>  <o:Template>Normal</o:Template>  <o:LastAuthor>Owen Cooper</o:LastAuthor>  <o:Revision>2</o:Revision>  <o:LastPrinted>2003-01-21T23:10:00Z</o:LastPrinted>  <o:Created>2003-02-25T19:07:00Z</o:Created>  <o:LastSaved>2003-02-25T19:07:00Z</o:LastSaved>  <o:Pages>3</o:Pages>  <o:Words>936</o:Words>  <o:Characters>5336</o:Characters>  <o:Company>UC Berkeley</o:Company>  <o:Lines>44</o:Lines>  <o:Paragraphs>10</o:Paragraphs>  <o:CharactersWithSpaces>6552</o:CharactersWithSpaces>  <o:Version>10.2418</o:Version> </o:DocumentProperties></xml><![endif]--><!--[if gte mso 9]><xml> <w:WordDocument>  <w:Zoom>80</w:Zoom>  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>  <w:DisplayVerticalDrawingGridEvery>0</w:DisplayVerticalDrawingGridEvery>  <w:UseMarginsForDrawingGridOrigin/> </w:WordDocument></xml><![endif]--><style><!-- /* Style Definitions */p.MsoNormal, li.MsoNormal, div.MsoNormal	{mso-style-parent:"";	margin:0in;	margin-bottom:.0001pt;	mso-pagination:widow-orphan;	font-size:12.0pt;	font-family:Times;}p.MsoBodyTextIndent, li.MsoBodyTextIndent, div.MsoBodyTextIndent	{margin-top:0in;	margin-right:0in;	margin-bottom:0in;	margin-left:.5in;	margin-bottom:.0001pt;	text-align:justify;	mso-pagination:widow-orphan;	font-size:12.0pt;	font-family:Times;}@page Section1	{size:8.5in 11.0in;	margin:1.0in 1.25in 1.0in 1.25in;	mso-header-margin:.5in;	mso-footer-margin:.5in;	mso-paper-source:0;}div.Section1	{page:Section1;} /* List Definitions */@list l0	{mso-list-id:138111058;	mso-list-type:hybrid;	mso-list-template-ids:-605494262 1115145 1639433 1770505 984073 1639433 1770505 984073 1639433 1770505;}@list l0:level1	{mso-level-text:"%1\)";	mso-level-tab-stop:.5in;	mso-level-number-position:left;	text-indent:-.25in;}@list l1	{mso-list-id:815223315;	mso-list-type:hybrid;	mso-list-template-ids:-2133845224 984073 1639433 1770505 984073 1639433 1770505 984073 1639433 1770505;}@list l1:level1	{mso-level-tab-stop:.5in;	mso-level-number-position:left;	text-indent:-.25in;}@list l2	{mso-list-id:2058315946;	mso-list-type:hybrid;	mso-list-template-ids:-852097376 984073 1639433 1770505 984073 1639433 1770505 984073 1639433 1770505;}@list l2:level1	{mso-level-tab-stop:.5in;	mso-level-number-position:left;	text-indent:-.25in;}ol	{margin-bottom:0in;}ul	{margin-bottom:0in;}--></style></head><body bgcolor=white lang=EN-US style='tab-interval:.5in'><div class=Section1><p class=MsoNormal>Wrapper infrastructure</p><p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal>This checkin merges the wrapper infrastructures developed byMehul and Sirish, and supports most of the functionality of both. </p><p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal>Streams</p><p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal>Streams are created using the DDL command CREATE STEAM whichhas the following syntax:</p><p class=MsoNormal style='text-align:justify;text-indent:.5in'>CREATE STREAM <i>streamname</i><spanstyle='font-style:normal'> (colname datatype, …) type ARCHIVED | UNARCHIVED</span></p><p class=MsoNormal style='text-align:justify;text-indent:.5in'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoBodyTextIndent>ARCHIVED streams will take data that is receivedfrom the wrapper and insert it into a relation named ‘streamname’.</p><p class=MsoBodyTextIndent><span style="mso-spacerun: yes">&nbsp;</span></p><p class=MsoNormal style='margin-left:.5in;text-align:justify'>UNARCHIVEDstreams use shared memory queues to communicate results between the wrapperclearinghouse process and the executor which scans the source.</p><p class=MsoNormal style='margin-left:.5in;text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Running queries over streams</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Streams behave like read-onlytables.<span style="mso-spacerun: yes">&nbsp; </span>They may be accessed usingthe select statement in the same way as normal Postgres tables with the restrictionthat normal Postgres tables and streams may not be mixed in a single query.</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Wrappers</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Wrappers are used to gather datafrom external sources and place that data into streams. Currently there is aone to one correspondence between a wrapper and a stream, although eventuallywe will want to allow a many to one relationship.<span style="mso-spacerun:yes">&nbsp; </span></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>The wrapper clearinghouse</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>A single Postgres process calledthe wrapper clearinghouse manages data acquisition.<span style="mso-spacerun:yes">&nbsp; </span>The clearinghouse is responsible for the followingoperations:</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><ol style='margin-top:0in' start=1 type=1> <li class=MsoNormal style='text-align:justify;mso-list:l2 level1 lfo2;     tab-stops:list .5in'>Accepting connections from external sources, and     obtaining the stream name from them.</li> <li class=MsoNormal style='text-align:justify;mso-list:l2 level1 lfo2;     tab-stops:list .5in'>Loading the appropriate user defined wrapper     functions.</li> <li class=MsoNormal style='text-align:justify;mso-list:l2 level1 lfo2;     tab-stops:list .5in'>Calling the appropriate wrapper function when data is     available on a connection.</li> <li class=MsoNormal style='text-align:justify;mso-list:l2 level1 lfo2;     tab-stops:list .5in'>Processing<span style="mso-spacerun: yes">&nbsp;     </span>result tuples returned by a wrapper according to the stream type.</li> <li class=MsoNormal style='text-align:justify;mso-list:l2 level1 lfo2;     tab-stops:list .5in'>Cleaning up when streams end</li></ol><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;</span></p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp; </span></p><p class=MsoNormal style='text-align:justify'>Providing data to a stream</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>TelegraphCQ currently supportspush based sources that are able to establish a connection with theclearinghouse process, and declare the stream name according to specificationbelow.</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>When a stream connects to thewrapper clearinghouse, it must declare its name.<span style="mso-spacerun:yes">&nbsp; </span>The name is specified as a variable length string in twoparts:</p><ol style='margin-top:0in' start=1 type=1> <li class=MsoNormal style='text-align:justify;mso-list:l1 level1 lfo3;     tab-stops:list .5in'>a four character null-terminated C style string which     contains the length of the stream name.</li> <li class=MsoNormal style='text-align:justify;mso-list:l1 level1 lfo3;     tab-stops:list .5in'>the stream name as a null terminated string.<span     style="mso-spacerun: yes">&nbsp; </span></li></ol><p class=MsoNormal style='margin-left:.25in;text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>By default the clearinghouselistens for connections on port 5533.<span style="mso-spacerun: yes">&nbsp;</span>The default may be overridden using the telegraphcqwchport option in thedatabase configuration file or by using the –w flag when starting up thepostmaster.<span style="mso-spacerun: yes">&nbsp; </span></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Wrapper functions</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Wrappers are responsible forreading data from a non-blocking network socket and transforming that data intothe correct types for the result stream.<span style="mso-spacerun:yes">&nbsp;&nbsp; </span>The wrapper functions are called only after a sourcehas connected to the wrapper clearinghouse and sent the stream name asdescribed above. </p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>A wrapper consists of threeseparate user defined functions: an initialization function, a next rowfunction, and a done function.<span style="mso-spacerun: yes">&nbsp;&nbsp;</span>There is no new DDL for associating wrapper functions with streams.<spanstyle="mso-spacerun: yes">&nbsp; </span>Instead, the wrapper function names arederived from the stream name followed by an underscore and the strings “init”,“next” or “done”.</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>These wrapper functions aredefined to Posgres using the Postgres CREATE FUNCTION DDL statement.<spanstyle="mso-spacerun: yes">&nbsp; </span>Each of these functions takes exactlyone integer argument which will be used to pass a pointer to a structure andreturn a Boolean which indicates if the function encountered a fatal error.<spanstyle="mso-spacerun: yes">&nbsp;&nbsp; </span>For example a wrapper named <i>foo</i><span style='font-style:normal'>compiled in the library </span><i>libwrapper.so</i><spanstyle='font-style:normal'> would be declared using the following DDL:</span></p><p class=MsoNormal style='text-align:justify'><b><i><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><b><i>create functionfoo_init(integer) returns boolean <o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><b><i>as'libwrapper.so','foo_init' language 'C';<o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><b><i>create functionfoo_next(integer) returns boolean <o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><b><i>as'libwrapper.so','foo_next' language 'C';<o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><b><i>create functionfoo_done(integer) returns boolean <o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><b><i>ˆas'libwrapper.so','foo_done' language 'C';<o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><b><i><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></i></b></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>How the functions are invoked</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>At runtime the wrapper willreceive a pointer to the following structure as its argument:</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>typedef struct wrapperstate</p><p class=MsoNormal style='text-align:justify'>{</p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>int fd;<span style="mso-spacerun:yes">&nbsp;&nbsp; </span></p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>TupleDesc tdesc;<span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span></p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>void *funcstate;<span style="mso-spacerun:yes">&nbsp;&nbsp; </span></p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>FunctionMode mode; </p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>Datum * returnTuple; </p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>char * returnTupleIsNull; </p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>int returnTupleLength; </p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>bool hasTuple;</p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>bool hasBufferedData;</p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;&nbsp;&nbsp; </span>bool<span style="mso-spacerun: yes">&nbsp;</span>connectionReady;</p><p class=MsoNormal style='text-align:justify'>} wrapperstate;</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Wrappers are called in two ways:1) in response to a data-ready indication from the poll system call, and 2)periodically if the wrapper declares that it holds buffered data.<spanstyle="mso-spacerun: yes">&nbsp; </span>The wrapper clearinghouse sets theconnectionReady flag of the wrapperstate function to indicate to the wrapperfunction that there is data available on the connection.<spanstyle="mso-spacerun: yes">&nbsp; </span>In turn, the wrapper may choose tobuffer data it has read from the connection, and may set the hasBufferedDataflag to indicate this circumstance to the wrapper clearinghouse.</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>The structure member named fd isthe file descriptor from which the wrapper can communicate with thesource.<span style="mso-spacerun: yes">&nbsp;&nbsp; </span>This socket has beenset up for nonblocking I/O because wrapper functions are not allowed to block.</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>The wrapper may be unable tofinish a complete operation in a single function call. The wrapper determineswhich wrapper function will be called next by the clearinghouse by setting<spanstyle="mso-spacerun: yes">&nbsp; </span>the FunctionMode filed to one of thefollowing four values: MODE_INIT, MODE_NEXT, MODE_DONE, MODE_END. The finalstate, MODE_END,<span style="mso-spacerun: yes">&nbsp; </span>indicates thatwrapper processing is completely done and the connection to the source may beclosed.<span style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp; </span>In addition todetermining call order, the wrapper must declare if it has returned data to thecaller using the hasTuple field. If the wrapper sets this field to true, thenthe clearinghouse will deliver the tuple stored in returnTuple. </p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>The wrapper functions return datato the wrapper clearinghouse using the returnTuple and returnTupleIsNullarrays.<span style="mso-spacerun: yes">&nbsp; </span>Each of these arrays hasbeen reallocated before the wrapper is called for the first time, and has alength equal to the value contained in the returnTupleLength field of thewrapstate structure.<span style="mso-spacerun: yes">&nbsp; </span>The data mustbe returned as Postgres Datums.<span style="mso-spacerun: yes">&nbsp;</span>These Datums must be the same type as is specified in the tupledescriptor for the return tuple which is passed to the wrapper in the tdescfield of the wrapstate structure. </p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'>Most wrapper functions will needto maintain their own state.<span style="mso-spacerun: yes">&nbsp; </span>Sincewrappers are passed the same wrapperstate<span style="mso-spacerun: yes">&nbsp;</span>structure each time they are called, the funcstate pointer may be usedfor this purpose.<span style="mso-spacerun: yes">&nbsp; </span>The funcstatepointer is initially set to null.<span style="mso-spacerun: yes">&nbsp;&nbsp;</span>Wrapper functions will typically allocate memory in their initializationfunctions using palloc, and free that memory using pfree just before returningfor the last time.</p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;</span></p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;</span></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p><p class=MsoNormal style='text-align:justify'><span style="mso-spacerun:yes">&nbsp;</span></p></div></body></html>